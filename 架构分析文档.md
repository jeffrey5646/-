# 邻加管理平台 - 架构分析文档

## 📋 项目概述

邻加管理平台是一个**轻量级权限管理中台**，用于统一管理线上巡检 App 的用户权限、功能授权和门店资源分配。

### 核心定位
- **统一权限控制中心**：集中管理所有 App 用户的账号、角色和功能权限
- **门店资源调度平台**：为不同角色分配管辖的门店资源
- **实时云端同步引擎**：基于 Supabase 实现配置即时生效

---

## 🏗️ 技术架构

### 技术栈
```
前端框架：React 19.2.3 + TypeScript 5.8.2
路由管理：React Router DOM 7.11.0
构建工具：Vite 6.2.0
后端服务：Supabase (PostgreSQL + Realtime)
UI 样式：Tailwind CSS (通过内联样式实现)
AI 集成：Google Gemini API (@google/genai)
```

### 项目结构
```
邻加管理平台/
├── components/          # UI 组件层
│   ├── Layout.tsx      # 主布局容器
│   └── Sidebar.tsx     # 侧边导航栏
├── pages/              # 页面层（核心业务）
│   ├── Login.tsx       # 登录页
│   ├── Dashboard.tsx   # 数据概览
│   ├── Users.tsx       # 员工档案与权限管理 ⭐
│   ├── Stores.tsx      # 门店资源管理
│   └── SuperAdmin.tsx  # 云端配置中心
├── services/           # 服务层
│   ├── supabaseClient.ts   # 数据库客户端（动态代理）
│   └── geminiService.ts    # AI 服务
├── types.ts            # 类型定义
├── constants.tsx       # 常量与 Mock 数据
└── App.tsx            # 应用入口
```

---

## 🔑 核心功能模块

### 1. 用户权限管理 (Users.tsx)

#### 功能特性
- ✅ 员工档案全生命周期管理（新增/编辑/查看）
- ✅ 基于角色的功能授权（RBAC）
- ✅ 门店资源动态指派
- ✅ 实时云端同步（Supabase Realtime）

#### 权限模型
```typescript
// 角色定义
enum UserRole {
  ADMIN = '超级管理员',           // 全局管理权限
  REGION_MANAGER = '大区经理',    // 区域管理权限
  INSPECTOR = '巡检员',           // 现场巡检权限
  STORE_MANAGER = '店长'          // 门店自检权限
}

// 功能权限列表
const APP_FEATURES = [
  'inspection_field',    // 现场巡店
  'inspection_self',     // 门店自检
  'task_center',         // 任务管理
  'analytics_deep',      // 深度分析
  'knowledge_base',      // 知识库
  'exam_center'          // 考试中心
]
```

#### 数据流程
```
1. 管理员在中台编辑用户权限
   ↓
2. 提交表单触发 Supabase 写入
   ↓
3. profiles 表更新（账号、角色、permissions 数组）
   ↓
4. stores 表更新（manager_id 外键关联）
   ↓
5. Realtime 订阅触发 App 端刷新
   ↓
6. App 登录时读取 permissions 控制功能显示
```

### 2. 门店管理 (Stores.tsx)

#### 功能特性
- 门店档案维护（名称、编码、状态）
- 负责人分配（通过 manager_id 外键）
- 门店状态监控（online/offline/warning）
- 巡检评分展示

### 3. 云端配置中心 (SuperAdmin.tsx)

#### 技术亮点：动态代理模式
```typescript
// 核心实现：supabaseClient.ts
let _internalClient: SupabaseClient;

export const supabase = new Proxy({} as SupabaseClient, {
  get(target, prop) {
    return _internalClient[prop];
  }
});

export const reinitializeSupabaseClient = () => {
  _internalClient = createNewInstance();
  // 无需刷新页面，内存中热重载
};
```

#### 解决的问题
- ❌ 传统方式：修改配置需要刷新页面 → 在 Google Cloud Preview 环境会 404
- ✅ 动态代理：配置保存后立即生效，无需刷新

---

## 🔄 与线上巡检 App 的集成方案

### 数据库表结构设计

#### profiles 表（用户档案）
```sql
CREATE TABLE profiles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,                    -- 真实姓名
  username TEXT UNIQUE NOT NULL,         -- 登录账号
  password TEXT NOT NULL,                -- 密码（建议加密）
  role TEXT NOT NULL,                    -- 角色枚举
  region TEXT,                           -- 所属区域
  phone TEXT,                            -- 联系电话
  avatar TEXT,                           -- 头像 URL
  permissions TEXT[] DEFAULT '{}',       -- 功能权限数组 ⭐
  assigned_stores UUID[] DEFAULT '{}',   -- 管辖门店 ID 数组
  status TEXT DEFAULT 'active',          -- 账号状态
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### stores 表（门店档案）
```sql
CREATE TABLE stores (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  code TEXT UNIQUE NOT NULL,             -- 门店编码
  name TEXT NOT NULL,                    -- 门店名称
  manager_id UUID REFERENCES profiles(id), -- 负责人外键 ⭐
  status TEXT DEFAULT 'online',          -- 运营状态
  last_score NUMERIC(5,2),               -- 最近评分
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### App 端权限验证流程

#### 1. 登录验证
```typescript
// App 端 Login.tsx
const handleLogin = async (username: string, password: string) => {
  const { data, error } = await supabase
    .from('profiles')
    .select('*')
    .eq('username', username)
    .eq('password', password)  // 生产环境需加密
    .single();
  
  if (data) {
    // 存储用户信息到本地
    localStorage.setItem('user', JSON.stringify(data));
    localStorage.setItem('permissions', JSON.stringify(data.permissions));
  }
};
```

#### 2. 功能权限控制
```typescript
// App 端权限 Hook
const usePermission = (featureKey: string) => {
  const permissions = JSON.parse(localStorage.getItem('permissions') || '[]');
  return permissions.includes(featureKey);
};

// 使用示例
const InspectionPage = () => {
  const canInspect = usePermission('inspection_field');
  
  if (!canInspect) {
    return <div>无权限访问</div>;
  }
  
  return <div>巡检功能...</div>;
};
```

#### 3. 门店数据过滤
```typescript
// App 端门店列表
const fetchMyStores = async (userId: string) => {
  // 方案 1：通过 manager_id 过滤
  const { data } = await supabase
    .from('stores')
    .select('*')
    .eq('manager_id', userId);
  
  // 方案 2：通过 assigned_stores 数组过滤
  const user = await supabase
    .from('profiles')
    .select('assigned_stores')
    .eq('id', userId)
    .single();
  
  const stores = await supabase
    .from('stores')
    .select('*')
    .in('id', user.data.assigned_stores);
};
```

---

## 🎯 开发建议

### 立即可做的优化

#### 1. 密码安全加固
```typescript
// 安装 bcrypt
npm install bcryptjs

// 中台注册时加密
import bcrypt from 'bcryptjs';
const hashedPassword = await bcrypt.hash(password, 10);

// App 登录时验证
const isValid = await bcrypt.compare(inputPassword, user.password);
```

#### 2. 添加 RLS 策略（Row Level Security）
```sql
-- 用户只能查看自己的档案
CREATE POLICY "Users can view own profile"
ON profiles FOR SELECT
USING (auth.uid() = id);

-- 店长只能查看自己管辖的门店
CREATE POLICY "Managers can view assigned stores"
ON stores FOR SELECT
USING (manager_id = auth.uid());
```

#### 3. 实时权限同步
```typescript
// App 端订阅权限变更
useEffect(() => {
  const channel = supabase
    .channel('permission_sync')
    .on('postgres_changes', {
      event: 'UPDATE',
      table: 'profiles',
      filter: `id=eq.${currentUserId}`
    }, (payload) => {
      // 权限被中台修改，立即更新本地
      localStorage.setItem('permissions', JSON.stringify(payload.new.permissions));
      alert('您的权限已更新，请重新登录');
    })
    .subscribe();
  
  return () => { supabase.removeChannel(channel); };
}, []);
```

### 架构扩展方向

#### 1. 多租户支持
```typescript
// 添加组织/公司维度
interface Organization {
  id: string;
  name: string;
  subdomain: string;  // 子域名隔离
}

// profiles 表添加 org_id 外键
```

#### 2. 审计日志
```sql
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  operator_id UUID REFERENCES profiles(id),
  action TEXT NOT NULL,  -- 'CREATE_USER', 'UPDATE_PERMISSION'
  target_id UUID,
  changes JSONB,         -- 变更前后对比
  ip_address TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### 3. 权限模板
```typescript
// 预设角色权限模板
const ROLE_TEMPLATES = {
  [UserRole.INSPECTOR]: ['inspection_field', 'task_center'],
  [UserRole.STORE_MANAGER]: ['inspection_self', 'task_center', 'exam_center'],
  [UserRole.ADMIN]: APP_FEATURES.map(f => f.key)  // 全部权限
};
```

---

## 🚀 快速集成步骤

### Step 1: 同步数据库结构
```bash
# 在线上巡检 App 的 Supabase 项目中执行
# 确保 profiles 表包含 permissions 和 assigned_stores 字段
```

### Step 2: 配置中台连接
```typescript
// 邻加管理平台 .env.local
SUPABASE_URL=你的线上巡检App的Supabase地址
SUPABASE_ANON_KEY=你的Anon Key
```

### Step 3: App 端添加权限验证
```typescript
// 创建 src/hooks/usePermission.ts
export const usePermission = (feature: string) => {
  const user = JSON.parse(localStorage.getItem('user') || '{}');
  return user.permissions?.includes(feature) || false;
};

// 在路由中使用
<Route 
  path="/inspection" 
  element={
    <ProtectedRoute requiredPermission="inspection_field">
      <InspectionPage />
    </ProtectedRoute>
  } 
/>
```

### Step 4: 测试完整流程
1. 在中台创建测试用户，授予部分权限
2. App 端登录该用户
3. 验证功能模块是否正确显示/隐藏
4. 在中台修改权限，App 端重新登录验证

---

## 📊 当前状态评估

### ✅ 已实现
- 基础权限管理 UI
- Supabase 动态代理
- 实时数据同步
- 门店资源分配

### ⚠️ 待完善
- 密码加密存储
- RLS 安全策略
- 审计日志记录
- 权限变更通知

### 🔮 未来规划
- 多租户架构
- 细粒度权限（按钮级）
- 权限申请审批流
- 数据权限隔离

---

## 💡 关键设计思想

1. **中台统一管控**：所有权限配置在中台完成，App 端只读取和执行
2. **实时同步机制**：利用 Supabase Realtime 实现配置即时生效
3. **动态代理模式**：解决配置热更新问题，提升开发体验
4. **RBAC + 资源绑定**：角色权限 + 门店资源双重控制
5. **前端权限控制**：通过 permissions 数组控制功能显示（后端需配合 RLS）

---

## 📞 技术支持

如需进一步开发协助，可以从以下方向入手：
- 数据库表结构优化
- RLS 策略编写
- App 端权限 Hook 封装
- 实时同步调试
- 安全加固方案
